<script>
  // Elements
  const video = document.getElementById('video');
  const fileInput = document.getElementById('fileInput');
  const urlInput = document.getElementById('urlInput');
  const loadUrlBtn = document.getElementById('loadUrlBtn');
  const playPauseBtn = document.getElementById('playPauseBtn');
  const captureBtn = document.getElementById('captureBtn');
  const captureAllBtn = document.getElementById('captureAllBtn');
  const gallery = document.getElementById('gallery');
  const imgFormat = document.getElementById('imgFormat');
  const imgQuality = document.getElementById('imgQuality');
  const outWidth = document.getElementById('outWidth');
  const outHeight = document.getElementById('outHeight');
  const keepAspect = document.getElementById('keepAspect');
  const seqStart = document.getElementById('seqStart');
  const seqEnd = document.getElementById('seqEnd');
  const seqInterval = document.getElementById('seqInterval');
  const downloadAllBtn = document.getElementById('downloadAll');
  const clearAllBtn = document.getElementById('clearAll');

  let captures = [];
  let seqTimer = null;

  // FILE LOAD
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (!file.type.startsWith("video/")) return alert("Select a valid video.");
    video.src = URL.createObjectURL(file);
    video.load();
    video.play().catch(()=>{});
  });

  // URL LOAD
  loadUrlBtn.addEventListener("click", () => {
    const url = urlInput.value.trim();
    if (!url) return alert("Enter a video URL first.");
    video.crossOrigin = "anonymous";
    video.src = url;
    video.load();
    video.play().catch(()=>{});
  });

  // PLAY / PAUSE
  playPauseBtn.addEventListener("click", () => {
    if (video.paused) video.play();
    else video.pause();
  });

  // SCREENSHOT
  function takeScreenshot() {
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return alert("Video not ready.");

    let ow = parseInt(outWidth.value) || w;
    let oh = parseInt(outHeight.value) || h;

    if (keepAspect.checked) {
      const ratio = w / h;
      if (ow && !oh) oh = Math.round(ow / ratio);
      if (oh && !ow) ow = Math.round(oh * ratio);
    }

    const canvas = document.createElement("canvas");
    canvas.width = ow;
    canvas.height = oh;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, ow, oh);

    const quality = imgFormat.value === "jpeg"
      ? imgQuality.value / 100
      : 1.0;

    const dataUrl = canvas.toDataURL("image/" + imgFormat.value, quality);

    addToGallery(dataUrl);
  }

  captureBtn.addEventListener("click", takeScreenshot);

  // CAPTURE SEQUENCE
  captureAllBtn.addEventListener("click", () => {
    const start = Number(seqStart.value);
    const end = Number(seqEnd.value);
    const interval = Number(seqInterval.value);

    if (start >= end)
      return alert("Start time must be less than end time.");

    video.currentTime = start;

    seqTimer = setInterval(() => {
      if (video.currentTime >= end) {
        clearInterval(seqTimer);
        seqTimer = null;
        return;
      }
      takeScreenshot();
      video.currentTime += interval;
    }, interval * 1000);
  });

  // Add to gallery
  function addToGallery(dataUrl) {
    const div = document.createElement("div");
    div.className = "thumb";
    div.innerHTML = `
      <img src="${dataUrl}">
      <div class="tools">
        <button class="icon-btn" onclick="downloadImage('${dataUrl}')">â¬‡</button>
        <button class="icon-btn" onclick="this.parentElement.parentElement.remove()">ðŸ—‘</button>
      </div>
    `;
    gallery.appendChild(div);
  }

  // Download one image
  window.downloadImage = function(dataUrl) {
    const a = document.createElement("a");
    a.href = dataUrl;
    a.download = "screenshot.png";
    a.click();
  };

  // CLEAR
  clearAllBtn.addEventListener("click", () => {
    gallery.innerHTML = "";
  });

  // DOWNLOAD ALL ZIP
  downloadAllBtn.addEventListener("click", async () => {
    const imgs = gallery.querySelectorAll("img");
    if (!imgs.length) return alert("No images to download.");

    const zip = new JSZip();
    let i = 1;

    for (let img of imgs) {
      const dataUrl = img.src;
      const base64 = dataUrl.split(",")[1];
      zip.file(`capture_${i}.png`, base64, { base64: true });
      i++;
    }

    const content = await zip.generateAsync({ type: "blob" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(content);
    a.download = "screenshots.zip";
    a.click();
  });
</script>

<!-- ZIP LIB -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
